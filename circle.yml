machine:
  java:
    version: oraclejdk8
  environment:
      ADB_INSTALL_TIMEOUT: 8
      GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'

  dependencies:
       override:
          - $ANDROID_HOME/tools/android list target
          - make bootstrap-circle
          - echo y | android update sdk --no-ui --all --filter android-25
          - echo y | android update sdk --no-ui --all --filter build-tools-25.0.0
          - echo y | android update sdk --no-ui --all --filter platform-tools
          - echo y | android update sdk --no-ui --all --filter extra-android-m2repository
          - echo y | android update sdk --no-ui --all --filter extra-google-m2repository
          - echo y | android update sdk --no-ui --all --filter extra-android-support
          - ./gradlew dependencies
       cache_directories:
          - ~/.gradle
          - ~/.android

  test:
      override:

      - mksdcard -l e 512M mysdcard.img
      - emulator -avd circleci-android22 -no-audio -no-window -sdcard mysdcard.img:
          background: true
          parallel: true

      - circle-android wait-for-boot
      - sleep 60

      #disable animations
      - adb shell settings put global window_animation_scale 0
      - adb shell settings put global transition_animation_scale 0
      - adb shell settings put global animator_duration_scale 0

      #unlock screen
      - adb shell input keyevent 82

      #TODO: copy google json mocks

      #running tests
      - ./gradlew clean lintMockDebug pmd findbugs checkstyle generateCodeCoverageReport

      post:
          #obtain test result artifacts
          - cp -r app/build/outputs/androidTest-results/* $CIRCLE_TEST_REPORTS